/*This sketch was written for the Electrorex Panther Logger Tutorial 10
The sketch reads the In-Situ RDO Pro sensor using SDI12 and parses
the data into float variables.

Wiring (RDO Pro wires to Panther Logger screw terminal ports):
White ---> D11
Red ---> 12VS
Black ---> GND
*/

//Libraries needed
#include <SDI12.h>
#include "Adafruit_MCP23X17.h"

Adafruit_MCP23X17 mcp;

#define sdi12pin 11
SDI12 sdi12(sdi12pin);

float INTemp1 = -9999; 
float INCond = -9999;
float INSal = -9999;
float INRes = -9999;
float INDens = -9999;
float INTDS = -9999;
float INRDO = -9999;
float INRDOS = -9999;
float INRDOP = -9999;
float INpH = -9999;
float INORP = -9999;
float INTemp2 = -9999;
 
void readTroll() {
    mcp.pinMode(7, OUTPUT);
    mcp.digitalWrite(7, HIGH); //Turn on 12VS rail
  
    unsigned int TrollNowTime = millis();
    unsigned int TrollInterval = 10000; //Give sensor 10 seconds to send good data
    while(TrollNowTime + TrollInterval > millis()){ 
      if(INTemp1 == -9999 || INTemp2 == -9999){
        sdi12.begin();
        sdi12.clearBuffer();
        sdi12.sendCommand("4M!");
        Serial.println(sdi12.readStringUntil('\n'));
        delay(15000);
        
        sdi12.clearBuffer();
        sdi12.sendCommand("4D0!");
        delay(100);

        for (uint8_t i = 0; i <= 3; i++){
          TrollData[i] = sdi12.parseFloat();
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
        INTemp1 = TrollData[1];
        INCond = TrollData[2];
        INSal = TrollData[3];

        sdi12.clearBuffer();
        sdi12.sendCommand("4D1!");                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
        delay(100);

        for (uint8_t i = 4; i <= 6; i++){
          TrollData[i] = sdi12.parseFloat();
        }

        INRes = TrollData[4];
        INDens = TrollData[5];
        INTDS = TrollData[6];

        sdi12.clearBuffer();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        sdi12.sendCommand("4D2!");                                                                                                    
        delay(100);

        for (uint8_t i = 7; i <= 9; i++){
          TrollData[i] = sdi12.parseFloat();
        }
     
        INRDO = TrollData[7];
        INRDOS = TrollData[8];
        INRDOP = TrollData[9];
        
        sdi12.clearBuffer();
        sdi12.sendCommand("4M1!");
        Serial.println(sdi12.readStringUntil('\n'));
        delay(15000);
        
        sdi12.clearBuffer();
        sdi12.sendCommand("4D0!");
        delay(100);

        for (uint8_t i = 10; i <= 12; i++){
          TrollData[i] = sdi12.parseFloat();
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
        INpH = TrollData[1];
        INORP = TrollData[2];
        INTemp2 = TrollData[3];
        sdi12.clearBuffer();
        sdi12.end();
    }
  }
   //mcp.pinMode(7, OUTPUT);
   //mcp.digitalWrite(7, LOW); //Turn off 12VS rail
}

void setup() {
  delay(5000); //wait a bit to get serial monitor up
  
  //Start all of the serial ports
  Serial.begin(115200);

  //Turn on red LED1 to indicate the program has started
  pinMode(13,OUTPUT);
  digitalWrite(13,HIGH);
  
  Serial.println("Setting things up. Please wait");

  Wire.begin();
  mcp.begin_I2C(0x20);

  mcp.pinMode(4, OUTPUT);
  mcp.digitalWrite(4, HIGH); //Turn on 3VS rail
  delay(100);
  
  mcp.pinMode(7, OUTPUT);
  mcp.digitalWrite(7, HIGH); //Turn off 12VS rail
  delay(100);
  
  mcp.pinMode(8, OUTPUT);
  mcp.digitalWrite(8, LOW); //Turn off indicator LED2
  delay(100);
  
  mcp.pinMode(9, OUTPUT);
  mcp.digitalWrite(9, LOW); //Turn off indicator LED3
  delay(100);
  
  mcp.pinMode(10, OUTPUT);
  mcp.digitalWrite(10, LOW); //Turn off indicator LED4
  delay(100);
  
  Serial.println("Setup finished");
}

void loop() {
  readTroll();
  
  delay(10000); //Wait ten seconds before doing another read
}
